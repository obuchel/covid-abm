name: üîç Debug Single Simulation

on:
  workflow_dispatch:

jobs:
  debug-simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Show repository structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo ""
          echo "=== All Python files ==="
          find . -name "*.py" -type f
          echo ""
          echo "=== Files in root ==="
          ls -la
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "jax[cpu]" numpy pandas matplotlib scipy tqdm
      
      - name: Test import
        run: |
          python << 'EOF'
          import sys
          import traceback
          
          print("=== Testing import ===")
          print(f"Python: {sys.version}")
          print(f"Path: {sys.path}")
          
          try:
              from covid_abm_model import FixedGPUABM
              print("‚úÖ Import successful!")
              
              # Check if save_timeseries parameter exists
              import inspect
              sig = inspect.signature(FixedGPUABM.run_simulation)
              print(f"run_simulation parameters: {list(sig.parameters.keys())}")
              
              if 'save_timeseries' in sig.parameters:
                  print("‚úÖ save_timeseries parameter found!")
              else:
                  print("‚ùå save_timeseries parameter MISSING!")
                  print("   This is the problem - model needs to be updated")
              
          except ImportError as e:
              print(f"‚ùå Import failed: {e}")
              traceback.print_exc()
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå Error: {e}")
              traceback.print_exc()
              sys.exit(1)
          EOF
      
      - name: Run minimal simulation
        run: |
          python << 'EOF'
          import sys
          import traceback
          import pandas as pd
          
          print("\n=== Running minimal simulation ===")
          
          try:
              from covid_abm_model import FixedGPUABM
              
              print("Creating model instance...")
              abm = FixedGPUABM()
              
              print("Initializing with N=100...")
              abm.initialize_simulation(N=100, seed=42)
              
              print("Running simulation (verbose=False)...")
              # Try WITHOUT save_timeseries first to see if that's the issue
              import inspect
              sig = inspect.signature(abm.run_simulation)
              
              if 'save_timeseries' in sig.parameters:
                  print("Using save_timeseries=True")
                  results = abm.run_simulation(verbose=False, save_timeseries=True)
              else:
                  print("‚ö†Ô∏è save_timeseries not available, using verbose=False only")
                  results = abm.run_simulation(verbose=False)
              
              print(f"‚úÖ Simulation completed!")
              print(f"Results keys: {list(results.keys())}")
              
              # Save results
              if 'timeseries' in results:
                  timeseries = results.pop('timeseries')
                  print(f"‚úÖ Found timeseries with {len(timeseries)} entries")
                  
                  # Save timeseries
                  ts_df = pd.DataFrame(timeseries)
                  ts_df.to_csv('results_timeseries.csv', index=False)
                  print("‚úÖ Saved timeseries")
              else:
                  print("‚ö†Ô∏è No timeseries in results")
                  # Create empty file so artifact upload doesn't fail
                  with open('results_timeseries.csv', 'w') as f:
                      f.write("day,infected,immune,long_covid\n")
              
              # Save summary
              summary_df = pd.DataFrame([results])
              summary_df.to_csv('results_summary.csv', index=False)
              print("‚úÖ Saved summary")
              
              print("\n=== Files created ===")
              import os
              for f in ['results_timeseries.csv', 'results_summary.csv']:
                  if os.path.exists(f):
                      size = os.path.getsize(f)
                      print(f"  {f}: {size} bytes")
              
          except Exception as e:
              print(f"\n‚ùå ERROR: {e}")
              print("\n=== Full traceback ===")
              traceback.print_exc()
              
              # Create empty files so we can see the error
              with open('error_log.txt', 'w') as f:
                  f.write(f"Error: {e}\n\n")
                  f.write("Traceback:\n")
                  traceback.print_exc(file=f)
              
              sys.exit(1)
          EOF
      
      - name: Show output files
        if: always()
        run: |
          echo "=== Output files ==="
          ls -lah *.csv *.txt 2>/dev/null || echo "No output files found"
          
          if [ -f results_summary.csv ]; then
            echo ""
            echo "=== Summary CSV ==="
            cat results_summary.csv
          fi
          
          if [ -f results_timeseries.csv ]; then
            echo ""
            echo "=== Timeseries CSV (first 5 lines) ==="
            head -n 5 results_timeseries.csv
          fi
          
          if [ -f error_log.txt ]; then
            echo ""
            echo "=== Error Log ==="
            cat error_log.txt
          fi
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-results
          path: |
            results_summary.csv
            results_timeseries.csv
            error_log.txt
          retention-days: 7
