name: Single COVID-19 Simulation
on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string
      num_replications:
        description: 'Not used'
        required: true
        default: '1'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install "jax[cpu]" numpy pandas
      
      - name: Run simulation
        run: |
          python << 'EOF'
          from covid_abm_model import FixedGPUABM
          import pandas as pd
          
          abm = FixedGPUABM()
          abm.config['max_days'] = ${{ github.event.inputs.simulation_days }}
          abm.config['covid_spread_chance_pct'] = ${{ github.event.inputs.spread_chance }}
          abm.config['precaution_pct'] = ${{ github.event.inputs.precaution_rate }}
          abm.config['vaccination_pct'] = ${{ github.event.inputs.vaccination_rate }}
          abm.initialize_simulation(N=${{ github.event.inputs.num_agents }}, seed=42)
          results = abm.run_simulation(verbose=True)
          pd.DataFrame([results]).to_csv('results.csv', index=False)
          EOF
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: results
          path: results.csv
