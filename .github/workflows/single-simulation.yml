name: Single COVID-19 Simulation
on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install "jax[cpu]" numpy pandas matplotlib
      
      - name: Run simulation
        env:
          NUM_AGENTS: ${{ github.event.inputs.num_agents }}
          SIMULATION_DAYS: ${{ github.event.inputs.simulation_days }}
          SPREAD_CHANCE: ${{ github.event.inputs.spread_chance }}
          PRECAUTION_RATE: ${{ github.event.inputs.precaution_rate }}
          VACCINATION_RATE: ${{ github.event.inputs.vaccination_rate }}
          RUN_ID: ${{ github.run_number }}
        run: |
          python3 -c "
          import os
          import time
          from covid_abm_model import FixedGPUABM
          import pandas as pd
          
          # Read parameters
          num_agents = int(os.environ['NUM_AGENTS'])
          simulation_days = int(os.environ['SIMULATION_DAYS'])
          spread_chance = float(os.environ['SPREAD_CHANCE'])
          precaution_rate = float(os.environ['PRECAUTION_RATE'])
          vaccination_rate = float(os.environ['VACCINATION_RATE'])
          run_id = int(os.environ['RUN_ID'])
          
          print(f'Run #{run_id}: {num_agents} agents, {simulation_days} days')
          print(f'Parameters: Spread={spread_chance}%, Precaution={precaution_rate}%, Vacc={vaccination_rate}%')
          
          # Initialize with UNIQUE seed based on run number and timestamp
          seed = run_id * 1000 + int(time.time()) % 1000
          
          abm = FixedGPUABM()
          abm.config['max_days'] = simulation_days
          abm.config['covid_spread_chance_pct'] = spread_chance
          abm.config['precaution_pct'] = precaution_rate
          abm.config['vaccination_pct'] = vaccination_rate
          
          abm.initialize_simulation(N=num_agents, seed=seed)
          results = abm.run_simulation(verbose=True, save_timeseries=True)
          
          # Extract timeseries
          timeseries_data = results.pop('timeseries', None)
          
          # Add metadata to summary
          results['spread_chance'] = spread_chance
          results['precaution_rate'] = precaution_rate
          results['vaccination_rate'] = vaccination_rate
          results['run_id'] = run_id
          results['seed'] = seed
          
          # Save files
          pd.DataFrame([results]).to_csv('results.csv', index=False)
          print('✅ Summary saved')
          
          if timeseries_data:
              ts_df = pd.DataFrame(timeseries_data)
              # Add parameters to each row for easy identification
              ts_df['spread_chance'] = spread_chance
              ts_df['precaution_rate'] = precaution_rate
              ts_df['vaccination_rate'] = vaccination_rate
              ts_df['run_id'] = run_id
              ts_df.to_csv('timeseries.csv', index=False)
              print(f'✅ Timeseries saved ({len(timeseries_data)} days)')
          
          print(f'✅ Complete! Seed: {seed}')
          "
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: run-${{ github.run_number }}-results
          path: |
            results.csv
            timeseries.csv
