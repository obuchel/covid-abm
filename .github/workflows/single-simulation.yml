name: Single COVID-19 Simulation

on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string
      num_replications:
        description: 'Number of parallel replications'
        required: true
        default: '5'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        replication: [1, 2, 3, 4, 5]
      fail-fast: false
      max-parallel: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install jax jaxlib numpy pandas matplotlib scipy tqdm
          fi
      
      - name: Run simulation (replication ${{ matrix.replication }})
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from covid_abm_model import FixedGPUABM
          import pandas as pd
          
          # Initialize and run simulation
          abm = FixedGPUABM()
          abm.config['max_days'] = ${{ github.event.inputs.simulation_days }}
          abm.config['covid_spread_chance_pct'] = ${{ github.event.inputs.spread_chance }}
          abm.config['precaution_pct'] = ${{ github.event.inputs.precaution_rate }}
          abm.config['vaccination_pct'] = ${{ github.event.inputs.vaccination_rate }}
          
          abm.initialize_simulation(
              N=${{ github.event.inputs.num_agents }},
              seed=42 + ${{ matrix.replication }}
          )
          
          results = abm.run_simulation(verbose=True, save_timeseries=True)
          
          # Save summary
          timeseries = results.pop('timeseries')
          summary_df = pd.DataFrame([results])
          summary_df['replication'] = ${{ matrix.replication }}
          summary_df.to_csv('results_summary_rep_${{ matrix.replication }}.csv', index=False)
          
          # Save timeseries
          ts_df = pd.DataFrame(timeseries)
          ts_df['replication'] = ${{ matrix.replication }}
          ts_df.to_csv('results_timeseries_rep_${{ matrix.replication }}.csv', index=False)
          
          print(f'\nSaved summary and timeseries data for replication ${{ matrix.replication }}')
          "
      
      - name: Upload summary results
        uses: actions/upload-artifact@v4
        with:
          name: summary-replication-${{ matrix.replication }}
          path: results_summary_rep_${{ matrix.replication }}.csv
          retention-days: 30
      
      - name: Upload timeseries results
        uses: actions/upload-artifact@v4
        with:
          name: timeseries-replication-${{ matrix.replication }}
          path: results_timeseries_rep_${{ matrix.replication }}.csv
          retention-days: 30

  aggregate:
    needs: simulate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pandas matplotlib numpy
      
      - name: Aggregate results
        run: |
          python -c "
          import pandas as pd
          import glob
          from pathlib import Path
          
          # Find all summary CSVs
          summary_files = glob.glob('results/**/results_summary_*.csv', recursive=True)
          timeseries_files = glob.glob('results/**/results_timeseries_*.csv', recursive=True)
          
          if not summary_files:
              print('No summary CSV files found!')
              exit(1)
          
          # Combine summary results
          summary_dfs = [pd.read_csv(f) for f in summary_files]
          combined_summary = pd.concat(summary_dfs, ignore_index=True)
          combined_summary.to_csv('combined_summary.csv', index=False)
          
          # Combine timeseries results
          if timeseries_files:
              ts_dfs = [pd.read_csv(f) for f in timeseries_files]
              combined_timeseries = pd.concat(ts_dfs, ignore_index=True)
              combined_timeseries.to_csv('combined_timeseries.csv', index=False)
              print(f'Combined {len(ts_dfs)} timeseries files')
          
          # Print summary
          print(f'\nCombined {len(summary_dfs)} replications')
          print(f'Summary rows: {len(combined_summary)}')
          
          if 'infected' in combined_summary.columns:
              print(f'Mean infected: {combined_summary[\"infected\"].mean():.0f}')
          if 'long_covid_cases' in combined_summary.columns:
              print(f'Mean long COVID: {combined_summary[\"long_covid_cases\"].mean():.0f}')
          
          print('\nColumns:', combined_summary.columns.tolist())
          "
      
      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: combined-results
          path: |
            combined_summary.csv
            combined_timeseries.csv
          retention-days: 90
