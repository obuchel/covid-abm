name: Single COVID-19 Simulation
on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string
      num_replications:
        description: 'Number of parallel replications'
        required: true
        default: '1'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install jax jaxlib numpy pandas matplotlib scipy tqdm
      
      - name: List files (debug)
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Files in current directory ==="
          ls -la
          echo "=== Looking for Python files ==="
          find . -name "*.py" -type f
      
      - name: Create test simulation script
        run: |
          cat > run_test.py << 'EOF'
          import sys
          import os
          
          # Try to import the model
          try:
              from covid_abm_model import FixedGPUABM
              print("âœ… Successfully imported FixedGPUABM")
          except ImportError as e:
              print(f"âŒ Failed to import: {e}")
              print(f"Python path: {sys.path}")
              print(f"Current dir: {os.getcwd()}")
              print(f"Files here: {os.listdir('.')}")
              sys.exit(1)
          
          import pandas as pd
          
          # Run a simple simulation
          print("\nğŸš€ Starting simulation...")
          abm = FixedGPUABM()
          
          # Set parameters
          abm.config['max_days'] = ${{ github.event.inputs.simulation_days }}
          abm.config['covid_spread_chance_pct'] = ${{ github.event.inputs.spread_chance }}
          abm.config['precaution_pct'] = ${{ github.event.inputs.precaution_rate }}
          abm.config['vaccination_pct'] = ${{ github.event.inputs.vaccination_rate }}
          
          # Initialize
          abm.initialize_simulation(
              N=${{ github.event.inputs.num_agents }},
              seed=42
          )
          
          # Run with timeseries tracking
          results = abm.run_simulation(verbose=True, save_timeseries=True)
          
          # Extract timeseries
          timeseries = results.pop('timeseries', None)
          
          # Save summary
          summary_df = pd.DataFrame([results])
          summary_df.to_csv('results_summary.csv', index=False)
          print(f"\nâœ… Saved summary to results_summary.csv")
          
          # Save timeseries if available
          if timeseries:
              ts_df = pd.DataFrame(timeseries)
              ts_df.to_csv('results_timeseries.csv', index=False)
              print(f"âœ… Saved timeseries ({len(timeseries)} days) to results_timeseries.csv")
          else:
              print("âš ï¸  No timeseries data available")
          
          print("\nâœ… Simulation complete!")
          EOF
          
          echo "=== Created run_test.py ==="
          cat run_test.py
      
      - name: Run simulation
        run: |
          python run_test.py
      
      - name: Verify output files
        run: |
          echo "=== Output files ==="
          ls -la *.csv || echo "No CSV files found"
          if [ -f results_summary.csv ]; then
            echo "=== Summary CSV ==="
            cat results_summary.csv
          fi
          if [ -f results_timeseries.csv ]; then
            echo "=== Timeseries CSV (first 10 lines) ==="
            head -n 10 results_timeseries.csv
          fi
      
      - name: Upload summary results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-results
          path: results_summary.csv
          retention-days: 30
      
      - name: Upload timeseries results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: timeseries-results
          path: results_timeseries.csv
          retention-days: 30
