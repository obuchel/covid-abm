name: Single COVID-19 Simulation

on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string
      num_replications:
        description: 'Number of parallel replications'
        required: true
        default: '5'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        replication: [1, 2, 3, 4, 5]
      fail-fast: false
      max-parallel: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install jax jaxlib numpy pandas matplotlib scipy tqdm
          fi
      
      - name: Run simulation (replication ${{ matrix.replication }})
        working-directory: covid-abm-web
        run: |
          python src/run_single_parameter.py \
            --parameter "covid_spread_chance_pct" \
            --value ${{ github.event.inputs.spread_chance }} \
            --n_runs 1 \
            --n_agents ${{ github.event.inputs.num_agents }} \
            --output "results_rep_${{ matrix.replication }}.csv"
      
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: results-replication-${{ matrix.replication }}
          path: covid-abm-web/results_rep_${{ matrix.replication }}.csv
          retention-days: 30

  aggregate-and-plot:
    needs: simulate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pandas matplotlib numpy seaborn
      
      - name: Aggregate results and create plots
        run: |
          python -c "
          import pandas as pd
          import matplotlib.pyplot as plt
          import numpy as np
          import glob
          from pathlib import Path
          
          # Find all result CSVs
          csv_files = glob.glob('results/**/*.csv', recursive=True)
          
          if not csv_files:
              print('No CSV files found!')
              exit(1)
          
          print(f'Found {len(csv_files)} result files')
          
          # Combine all results
          dfs = [pd.read_csv(f) for f in csv_files]
          combined = pd.concat(dfs, ignore_index=True)
          
          # Save combined results
          combined.to_csv('combined_results.csv', index=False)
          print(f'Combined {len(dfs)} replications into {len(combined)} rows')
          
          # Print summary
          print('\nColumns found:', combined.columns.tolist())
          
          # Create comprehensive plots
          fig, axes = plt.subplots(2, 2, figsize=(15, 10))
          fig.suptitle('COVID-19 Simulation Results', fontsize=16, fontweight='bold')
          
          # Plot 1: Infections
          ax1 = axes[0, 0]
          if 'infected' in combined.columns:
              ax1.hist(combined['infected'], bins=20, color='blue', alpha=0.7, edgecolor='black')
              mean_val = combined['infected'].mean()
              ax1.axvline(mean_val, color='red', linestyle='--', linewidth=2, label=f'Mean: {mean_val:.0f}')
              ax1.set_xlabel('Total Infected Cases')
              ax1.set_ylabel('Frequency')
              ax1.set_title('Distribution of Total Infections', fontweight='bold')
              ax1.legend()
              ax1.grid(True, alpha=0.3)
              print(f'\nMean infected: {mean_val:.0f}')
          
          # Plot 2: Long COVID
          ax2 = axes[0, 1]
          if 'long_covid_cases' in combined.columns:
              ax2.hist(combined['long_covid_cases'], bins=20, color='red', alpha=0.7, edgecolor='black')
              mean_val = combined['long_covid_cases'].mean()
              ax2.axvline(mean_val, color='darkred', linestyle='--', linewidth=2, label=f'Mean: {mean_val:.0f}')
              ax2.set_xlabel('Long COVID Cases')
              ax2.set_ylabel('Frequency')
              ax2.set_title('Distribution of Long COVID Cases', fontweight='bold')
              ax2.legend()
              ax2.grid(True, alpha=0.3)
              print(f'Mean long COVID: {mean_val:.0f}')
          
          # Plot 3: Reinfections
          ax3 = axes[1, 0]
          if 'reinfected' in combined.columns:
              ax3.hist(combined['reinfected'], bins=20, color='orange', alpha=0.7, edgecolor='black')
              mean_val = combined['reinfected'].mean()
              ax3.axvline(mean_val, color='darkorange', linestyle='--', linewidth=2, label=f'Mean: {mean_val:.0f}')
              ax3.set_xlabel('Reinfection Cases')
              ax3.set_ylabel('Frequency')
              ax3.set_title('Distribution of Reinfections', fontweight='bold')
              ax3.legend()
              ax3.grid(True, alpha=0.3)
              print(f'Mean reinfections: {mean_val:.0f}')
          
          # Plot 4: Productivity
          ax4 = axes[1, 1]
          if 'min_productivity' in combined.columns:
              ax4.hist(combined['min_productivity'], bins=20, color='green', alpha=0.7, edgecolor='black')
              mean_val = combined['min_productivity'].mean()
              ax4.axvline(mean_val, color='darkgreen', linestyle='--', linewidth=2, label=f'Mean: {mean_val:.1f}%')
              ax4.set_xlabel('Minimum Productivity (%)')
              ax4.set_ylabel('Frequency')
              ax4.set_title('Minimum Productivity Distribution', fontweight='bold')
              ax4.legend()
              ax4.grid(True, alpha=0.3)
              print(f'Mean min productivity: {mean_val:.1f}%')
          
          plt.tight_layout()
          plt.savefig('simulation_plots.png', dpi=300, bbox_inches='tight')
          print('\n✅ Plots saved to simulation_plots.png')
          
          # Create summary statistics text file
          with open('summary.txt', 'w') as f:
              f.write('COVID-19 SIMULATION RESULTS\n')
              f.write('='*60 + '\n\n')
              f.write(f'Number of replications: {len(dfs)}\n')
              f.write(f'Total data points: {len(combined)}\n\n')
              
              metrics = {
                  'infected': 'Total Infected',
                  'reinfected': 'Reinfections', 
                  'long_covid_cases': 'Long COVID Cases',
                  'min_productivity': 'Min Productivity (%)',
                  'runtime_days': 'Epidemic Duration (days)'
              }
              
              for col, name in metrics.items():
                  if col in combined.columns:
                      f.write(f'{name}:\n')
                      f.write(f'  Mean:   {combined[col].mean():.2f}\n')
                      f.write(f'  Median: {combined[col].median():.2f}\n')
                      f.write(f'  Std:    {combined[col].std():.2f}\n')
                      f.write(f'  Min:    {combined[col].min():.2f}\n')
                      f.write(f'  Max:    {combined[col].max():.2f}\n\n')
          
          print('✅ Summary saved to summary.txt')
          "
      
      - name: Upload results package
        uses: actions/upload-artifact@v4
        with:
          name: results-with-plots
          path: |
            combined_results.csv
            simulation_plots.png
            summary.txt
          retention-days: 90
