name: Single COVID-19 Simulation
on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of agents'
        required: true
        default: '10000'
        type: string
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '180'
        type: string
      spread_chance:
        description: 'Spread chance (%)'
        required: true
        default: '10'
        type: string
      precaution_rate:
        description: 'Precaution rate (%)'
        required: true
        default: '50'
        type: string
      vaccination_rate:
        description: 'Vaccination rate (%)'
        required: true
        default: '80'
        type: string
      num_replications:
        description: 'Not used'
        required: true
        default: '1'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install "jax[cpu]" numpy pandas matplotlib
      
      - name: Run simulation
        env:
          NUM_AGENTS: ${{ github.event.inputs.num_agents }}
          SIMULATION_DAYS: ${{ github.event.inputs.simulation_days }}
          SPREAD_CHANCE: ${{ github.event.inputs.spread_chance }}
          PRECAUTION_RATE: ${{ github.event.inputs.precaution_rate }}
          VACCINATION_RATE: ${{ github.event.inputs.vaccination_rate }}
        run: |
          python3 -c "
          import os
          from covid_abm_model import FixedGPUABM
          import pandas as pd
          
          # Read parameters from environment variables
          num_agents = int(os.environ['NUM_AGENTS'])
          simulation_days = int(os.environ['SIMULATION_DAYS'])
          spread_chance = float(os.environ['SPREAD_CHANCE'])
          precaution_rate = float(os.environ['PRECAUTION_RATE'])
          vaccination_rate = float(os.environ['VACCINATION_RATE'])
          
          print(f'Starting simulation with {num_agents} agents for {simulation_days} days')
          
          # Initialize and configure ABM
          abm = FixedGPUABM()
          abm.config['max_days'] = simulation_days
          abm.config['covid_spread_chance_pct'] = spread_chance
          abm.config['precaution_pct'] = precaution_rate
          abm.config['vaccination_pct'] = vaccination_rate
          
          # Run simulation
          abm.initialize_simulation(N=num_agents, seed=42)
          results = abm.run_simulation(verbose=True, save_timeseries=False)
          
          # Remove timeseries if present to save only summary
          if 'timeseries' in results:
              del results['timeseries']
          
          # Save results
          pd.DataFrame([results]).to_csv('results.csv', index=False)
          print('Simulation completed successfully!')
          print(f'Results saved to results.csv')
          "
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: results
          path: results.csv
