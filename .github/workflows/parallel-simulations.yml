

name: Run Parallel COVID Simulations

on:
  workflow_dispatch:
    inputs:
      num_agents:
        description: 'Number of Agents'
        required: true
        default: '10000'
      simulation_days:
        description: 'Simulation Days'
        required: true
        default: '180'
      spread_chance:
        description: 'Spread Chance (%)'
        required: true
        default: '10'
      precaution_rate:
        description: 'Precaution Rate (%)'
        required: true
        default: '50'
      vaccination_rate:
        description: 'Vaccination Rate (%)'
        required: true
        default: '80'
      num_replications:
        description: 'Number of Parallel Replications'
        required: true
        default: '5'

jobs:
  run-simulations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        replication: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      max-parallel: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install numpy pandas matplotlib numba
        # Add any other dependencies from requirements.txt
    
    - name: Run simulation
      run: |
        python src/run_single_parameter.py \
          --num_agents ${{ github.event.inputs.num_agents }} \
          --simulation_days ${{ github.event.inputs.simulation_days }} \
          --spread_chance ${{ github.event.inputs.spread_chance }} \
          --precaution_rate ${{ github.event.inputs.precaution_rate }} \
          --vaccination_rate ${{ github.event.inputs.vaccination_rate }} \
          --replication ${{ matrix.replication }}
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: simulation-results-${{ matrix.replication }}
        path: results/simulation_${{ matrix.replication }}.csv
        retention-days: 7

  aggregate-results:
    needs: run-simulations
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install numpy pandas matplotlib
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: results/
    
    - name: Aggregate results
      run: |
        python src/aggregate_results_file.py --input_dir results/
    
    - name: Upload aggregated results
      uses: actions/upload-artifact@v3
      with:
        name: aggregated-results
        path: |
          results/aggregated_*.csv
          results/summary_*.json
          results/plots/*.png
        retention-days: 30
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./results
        destination_dir: simulation-results/${{ github.run_id }}