name: COVID-19 ABM Parameter Sweep

on:
  workflow_dispatch:
    inputs:
      parameter_name:
        description: 'Parameter to sweep'
        required: true
        default: 'covid_spread_chance_pct'
        type: choice
        options:
          - covid_spread_chance_pct
          - initial_infected_agents
          - precaution_pct
          - avg_degree
          - vaccination_pct
          - v_start_time
      n_runs:
        description: 'Number of runs per parameter value'
        required: true
        default: '10'
        type: string
      n_agents:
        description: 'Number of agents'
        required: true
        default: '100000'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up parameter matrix
        id: set-matrix
        run: |
          case "${{ github.event.inputs.parameter_name }}" in
            covid_spread_chance_pct)
              echo 'matrix={"value":[2,5,10,20]}' >> $GITHUB_OUTPUT
              ;;
            initial_infected_agents)
              echo 'matrix={"value":[2,5,10,20]}' >> $GITHUB_OUTPUT
              ;;
            precaution_pct)
              echo 'matrix={"value":[0,30,50,80]}' >> $GITHUB_OUTPUT
              ;;
            avg_degree)
              echo 'matrix={"value":[10,30,50,70]}' >> $GITHUB_OUTPUT
              ;;
            vaccination_pct)
              echo 'matrix={"value":[0,30,50,80]}' >> $GITHUB_OUTPUT
              ;;
            v_start_time)
              echo 'matrix={"value":[0,30,180,360]}' >> $GITHUB_OUTPUT
              ;;
          esac

  simulate:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.setup.outputs.matrix)}}
      fail-fast: false
      max-parallel: 4  # Run 4 values in parallel
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run simulation for value ${{ matrix.value }}
        run: |
          python src/run_single_parameter.py \
            --parameter "${{ github.event.inputs.parameter_name }}" \
            --value ${{ matrix.value }} \
            --n_runs ${{ github.event.inputs.n_runs }} \
            --n_agents ${{ github.event.inputs.n_agents }} \
            --output "results_${{ matrix.value }}.csv"
      
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.value }}
          path: results_${{ matrix.value }}.csv
          retention-days: 30

  aggregate:
    needs: simulate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pandas matplotlib numpy
      
      - name: Aggregate results and create plots
        run: |
          python src/aggregate_results.py \
            --input_dir results/ \
            --output combined_results.csv \
            --plot parameter_sweep.png
      
      - name: Create summary
        run: |
          python src/create_summary.py \
            --input combined_results.csv \
            --output summary.md
      
      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: combined-results
          path: |
            combined_results.csv
            parameter_sweep.png
            summary.md
          retention-days: 90
strategy:
  matrix: ${{fromJson(needs.setup.outputs.matrix)}}
  fail-fast: false
  max-parallel: 4  # Adjust based on GitHub plan
- name: Upload results artifact
  uses: actions/upload-artifact@v4
  with:
    name: results-${{ matrix.value }}
    path: results_${{ matrix.value }}.csv
    retention-days: 30  # Adjust as needed (1-90 days)